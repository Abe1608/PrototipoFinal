<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>@ViewBag.Title - FitStyle</title>
    <link rel="icon" type="image/png" href="~/images/logo/Logo.png" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="~/Content/Site.css" />
</head>
<body class="bg-light">
    @{
        // Obtener datos del carrito del usuario ingresado

        int carritoCount = 0;

        if (User.Identity.IsAuthenticated)
        {
            using (var db = new PrototipoFinal.Models.FitStyleDBEntities())
            {
                var email = User.Identity.Name;
                var usuario = db.Usuarios.SingleOrDefault(u => u.email == email);

                if (usuario != null)
                {
                    var carritoUser = db.Carritos
                        .SingleOrDefault(c => c.id_usuario == usuario.id_usuario
                                           && c.estado == "Abierto");

                    if (carritoUser != null)
                    {
                        carritoCount = db.Carrito_Detalle
                            .Where(d => d.id_carrito == carritoUser.id_carrito)
                            .Sum(d => (int?)d.cantidad) ?? 0;
                    }
                }
            }
        }
    }
    <nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom sticky-top">
        <div class="container">
            <a class="navbar-brand fw-bold" href="@Url.Action("Index","Home")">FitStyle</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#nav"><span class="navbar-toggler-icon"></span></button>
            <div id="nav" class="collapse navbar-collapse">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item"><a class="nav-link" href="@Url.Action("Index","Home")">Inicio</a></li>
                    <li class="nav-item"><a class="nav-link" href="@Url.Action("Index","Productos")">Catálogo</a></li>
                    <li class="nav-item"><a class="nav-link" href="@Url.Action("Pagar","Checkout")">Pagos</a></li>
                </ul>
                <div class="d-flex gap-2">
                    @if (User.Identity.IsAuthenticated)
                    {
                        <span class="navbar-text small text-muted">Hola, @User.Identity.Name</span>
                        <a class="btn btn-outline-secondary" href="@Url.Action("Logout","Account")">Cerrar sesión</a>
                    }
                    else
                    {
                        <a class="btn btn-dark" href="@Url.Action("Login","Account", new { returnUrl = Request.RawUrl })">Iniciar sesión</a>
                    }
                    <button class="btn btn-outline-secondary d-flex align-items-center gap-2 position-relative"
                            type="button"
                            data-bs-toggle="offcanvas"
                            data-bs-target="#carritoOffcanvas">
                        <i class="bi bi-cart3" style="font-size: 18px;"></i>
                        Carrito

                        <span id="carrito-count"
                              class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger @(carritoCount == 0 ? "d-none" : "")"
                              style="font-size: 12px;">
                            @carritoCount
                        </span>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <main class="container py-4">@RenderBody()</main>

    <div id="carritoOffcanvasWrapper">
        @Html.Action("Offcanvas", "Carrito")
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script>
        var urlAgregarCarrito   = '@(Url.Action("AgregarPorProducto", "Carrito"))';
        var urlOffcanvasCarrito = '@(Url.Action("Offcanvas", "Carrito"))';
        var urlLogin = '@Url.Action("Login", "Account", new { returnUrl = Request.RawUrl })';
    </script>

    <script src="~/Scripts/site.js"></script>
</body>
</html>